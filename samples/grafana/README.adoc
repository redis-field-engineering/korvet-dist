= Grafana Metrics Demo
:toc:
:icons: font

A complete, self-contained demo environment with Korvet, Redis, Prometheus, Grafana, and load generators.

== What's Included

* **Redis Stack Server** - Message storage backend
* **Korvet Server** - Kafka-compatible streaming service
* **Prometheus** - Metrics collection
* **Grafana** - Metrics visualization with pre-built dashboard
* **Load Generator (Producer)** - Produces messages at configurable rate (default: 1000 msg/sec)
* **Load Generator (Consumer)** - Continuously consumes messages

== Quick Start

=== Prerequisites

* Docker and Docker Compose installed

=== Start the Demo Stack

[source,bash]
----
cd samples/grafana-demo
docker compose up -d
----

=== Access the Services

* **Grafana**: http://localhost:3000 (admin/admin)
* **Prometheus**: http://localhost:9090
* **Korvet Metrics**: http://localhost:8080/actuator/prometheus
* **Korvet Server**: localhost:9092 (Kafka protocol)
* **Redis**: localhost:6379

=== View the Dashboard

. Open http://localhost:3000
. Login with `admin/admin`
. Navigate to **Dashboards** → **Korvet Metrics**
. Watch the metrics update in real-time

=== View the Logs

[source,bash]
----
# View all logs
docker compose logs -f

# View specific service logs
docker compose logs -f korvet
docker compose logs -f load-generator-producer
docker compose logs -f load-generator-consumer
----

=== Stop the Demo Stack

[source,bash]
----
docker compose down
----

To remove all data:

[source,bash]
----
docker compose down -v
----

== What You'll See

Once the stack is running, you'll see:

* **Produce Rate**: ~1000 messages/second being produced to `load-test` topic
* **Produce Latency**: p50, p95, p99 latency metrics for produce operations
* **Fetch Rate**: Messages fetched per second
* **Fetch Latency**: p50, p95, p99 latency metrics for fetch operations
* **Ingress Throughput**: Bytes per second being produced (ingress)
* **Egress Throughput**: Bytes per second being fetched (egress)
* **Error Rate**: Should be 0% under normal operation

**Redis Command Metrics Section** (use the "Redis Command" dropdown to filter):

* **Command Rate**: Operations per second for selected command(s)
* **Latency Percentiles**: p50, p95, p99 latency for selected command(s)
* **Average Latency**: Mean latency for selected command(s)

**JVM & System Metrics Section**:

* **Heap Used**: Heap memory usage as percentage (gauge with thresholds)
* **Non-Heap Used**: Non-heap memory usage as percentage (gauge with thresholds)
* **CPU Usage**: Process and system CPU utilization
* **Load Average**: System load average (1 minute)
* **GC Pause Duration**: Garbage collection pause time by action and cause
* **GC Count**: Garbage collection frequency by action and cause
* **Threads**: Live, daemon, and peak thread counts

== Customizing the Load

=== Change Producer Rate

Set the `PRODUCER_RATE` environment variable:

[source,bash]
----
# 5000 messages per second
PRODUCER_RATE=5000 docker compose up -d

# 100 messages per second
PRODUCER_RATE=100 docker compose up -d
----

=== Add More Consumers

[source,bash]
----
docker compose up -d --scale load-generator-consumer=3
----

== Troubleshooting

=== Services Not Starting

Check the logs:

[source,bash]
----
docker compose logs
----

=== No Metrics in Grafana

. Verify Korvet is healthy: `curl http://localhost:8080/actuator/health`
. Check Prometheus targets: http://localhost:9090/targets
. Verify load generators are running: `docker compose ps`

=== Consumer Not Receiving Messages

The consumer may take 15-20 seconds to start after Korvet is ready. Check logs:

[source,bash]
----
docker compose logs load-generator-consumer
----

== Next Steps

* Experiment with different load patterns
* Try connecting your own Kafka clients to `localhost:9092`
* Explore Prometheus queries at http://localhost:9090
* Create custom Grafana dashboards
* Check Redis Streams data: `docker compose exec redis redis-cli XINFO STREAM load-test`

== Architecture

[source,text]
----
┌─────────────────┐
│ Load Generator  │
│   (Producer)    │
└────────┬────────┘
         │ Kafka Protocol
         ▼
    ┌────────┐      ┌───────┐
    │ Korvet │─────▶│ Redis │
    │ :9092  │      │ :6379 │
    └────┬───┘      └───────┘
         │ Kafka Protocol
         ▼
┌─────────────────┐
│ Load Generator  │
│   (Consumer)    │
└─────────────────┘

    ┌────────┐
    │ Korvet │
    │ :8080  │ /actuator/prometheus
    └────┬───┘
         │
         ▼
    ┌──────────┐      ┌─────────┐
    │Prometheus│─────▶│ Grafana │
    │  :9090   │      │  :3000  │
    └──────────┘      └─────────┘
----
