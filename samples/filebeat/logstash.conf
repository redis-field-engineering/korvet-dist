# Logstash Configuration for Korvet Sample
#
# This configuration consumes events from Korvet using the Kafka input plugin,
# processes them, and outputs to both file and stdout for demonstration.

# ============================= Input ==========================================

input {
  # Consume from Korvet using Kafka protocol
  kafka {
    # Korvet server endpoint (Kafka-compatible)
    bootstrap_servers => "korvet:9092"
    
    # Topic to consume from (matches Filebeat output topic)
    topics => ["filebeat-logs"]
    
    # Consumer group ID
    group_id => "logstash-consumer-group"
    
    # Codec for message deserialization
    codec => "json"
    
    # Consumer settings
    consumer_threads => 1
    auto_offset_reset => "earliest"  # Start from beginning for demo
    
    # Client ID for debugging
    client_id => "logstash-sample"
    
    # Polling settings
    poll_timeout_ms => 100
    session_timeout_ms => 10000
    max_poll_records => 500
  }
}

# ============================= Filter =========================================

filter {
  # Add processing metadata
  mutate {
    add_field => {
      "processed_by" => "logstash"
      "processed_at" => "%{@timestamp}"
      "pipeline" => "korvet-sample"
    }
  }
  
  # Parse timestamp if present
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss'Z'"]
      target => "log_timestamp"
    }
  }
  
  # Add severity level for alerting
  if [level] == "ERROR" {
    mutate {
      add_field => { "severity" => "high" }
      add_tag => ["error", "alert"]
    }
  } else if [level] == "WARN" {
    mutate {
      add_field => { "severity" => "medium" }
      add_tag => ["warning"]
    }
  } else {
    mutate {
      add_field => { "severity" => "low" }
      add_tag => ["info"]
    }
  }
  
  # Extract user information if present
  if [user_id] {
    mutate {
      add_tag => ["user-activity"]
    }
  }
  
  # Add performance metrics tag if duration is present
  if [duration_ms] {
    mutate {
      add_tag => ["performance-metrics"]
    }
    
    # Flag slow requests (> 300ms)
    if [duration_ms] > 300 {
      mutate {
        add_tag => ["slow-request"]
      }
    }
  }
}

# ============================= Output =========================================

output {
  # Write to file for persistence and verification
  file {
    path => "/output/processed-logs.json"
    codec => "json_lines"
  }
  
  # Output to stdout for debugging (visible in docker-compose logs)
  stdout {
    codec => rubydebug {
      metadata => false
    }
  }
  
  # Conditional outputs based on severity
  # In production, you might send errors to alerting systems
  if "error" in [tags] {
    file {
      path => "/output/errors.json"
      codec => "json_lines"
    }
  }
  
  if "slow-request" in [tags] {
    file {
      path => "/output/slow-requests.json"
      codec => "json_lines"
    }
  }
}

