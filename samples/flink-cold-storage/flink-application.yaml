# FlinkDeployment for Korvet Cold Storage Writer
# Requires Flink Kubernetes Operator: https://nightlies.apache.org/flink/flink-kubernetes-operator-docs-main/
apiVersion: flink.apache.org/v1beta1
kind: FlinkDeployment
metadata:
  name: korvet-flink-cold-storage
  labels:
    app: korvet-flink
    component: cold-storage-writer
spec:
  image: redisfield/korvet-flink:latest
  flinkVersion: v1_20
  flinkConfiguration:
    taskmanager.numberOfTaskSlots: "2"
    state.backend: hashmap
    state.checkpoints.dir: s3a://korvet-bucket/checkpoints
    state.savepoints.dir: s3a://korvet-bucket/savepoints
    # S3 filesystem configuration
    s3.endpoint: ""  # Set for MinIO/LocalStack
    s3.path.style.access: "true"
  serviceAccount: korvet-flink
  jobManager:
    resource:
      memory: "1024m"
      cpu: 0.5
  taskManager:
    resource:
      memory: "2048m"
      cpu: 1
    replicas: 1
  podTemplate:
    spec:
      containers:
        - name: flink-main-container
          envFrom:
            - configMapRef:
                name: korvet-flink-config
            - secretRef:
                name: korvet-flink-secret
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: korvet-flink-secret
                  key: AWS_ACCESS_KEY_ID
                  optional: true
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: korvet-flink-secret
                  key: AWS_SECRET_ACCESS_KEY
                  optional: true
  job:
    jarURI: local:///opt/flink/usrlib/korvet-flink.jar
    entryClass: com.redis.korvet.flink.FlinkStreamWriter
    args:
      - "--redis-uri"
      - "$(REDIS_URI)"
      - "--storage-path"
      - "$(STORAGE_PATH)"
      - "--key-pattern"
      - "$(KEY_PATTERN)"
      - "--consumer-group"
      - "$(CONSUMER_GROUP)"
      - "--boundedness"
      - "$(BOUNDEDNESS)"
      - "--checkpoint-interval-ms"
      - "$(CHECKPOINT_INTERVAL_MS)"
      - "--s3-region"
      - "$(S3_REGION)"
    parallelism: 2
    upgradeMode: stateless

